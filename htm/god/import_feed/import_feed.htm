<%inherit file="/god/_base.htm" />
<%!
from yajl import dumps
from cgi import escape
from model.import_feed import ImportFeed, IMPORT_FEED_STATE_INIT
from model.douban import is_rt_by_title
from config import API_URL
%>
<%def name="htm_head()">
<style>
    #tags{
        font-size:16px;
        padding:3px;
        width:90%;
    }
    .redis_cid{
        width:60%;
    }
    .redis_cid span{
        float:left;
        margin-left:27px;
        margin-top:14px;
    }
    #title{
        padding:7px;
        width:90%;
        display:block;
        margin:14px 0;
    }
    .check{
        font-size:16px;
        margin-top:14px
    }
    .check label{
        margin-right:32px
    }
    #txt
    {
        width:90%;
        height:500px;
        padding:3px 7px;
    }
    #okbtn{
        padding:7px 30px;
        margin-top:14px;    
    }
    #nobtn{
        float:right;
        margin-right:10%
    } 
</style>
<style>
.token-input-delete-token-42qu{
width:17px;
height:19px;
background:url(http://s.realfex.xxx/img/png/label.png) no-repeat -35px 0;
display:inline-block;
height:23px;
vertical-align:-7px;
}
ul.token-input-list-42qu {
    overflow: hidden; 
    height: auto !important; 
    height: 1%;
    width: 400px;
    border: 1px solid #8496ba;
    cursor: text;
    font-size: 12px;
    font-family: Verdana;
    min-height: 1px;
    z-index: 999;
    margin: 0;
    padding: 0;
    background-color: #fff;
    list-style-type: none;
    clear: left;
}

ul.token-input-list-42qu li input {
    border: 0;
    width: 100px;
    padding: 3px 8px;
    background-color: white;
    margin: 2px 0;
    -webkit-appearance: caret;
}

li.token-input-token-42qu {
float:left;
color:#000;
    background:#fff;
    display:inline-block;
    font-size:12px;
margin:3px;
}

li.token-input-token-42qu p {
    display:inline-block;
    margin: 0;
    line-height:21px;
    height:21px;
    border:1px solid #ececec;
    border-left:0;
    border-bottom:1px solid #D9D8DA;
    border-right:1px solid #ddd;
    padding:0 6px;
}

li.token-input-token-42qu span {
    color: #a6b3cf;
    margin-left: 5px;
    font-weight: bold;
    cursor: pointer;
}



li.token-input-selected-token-42qu p{
    background-color: #f3fcff;
    color:#d20;
}
li.token-input-selected-token-42qu span{
    background-position:-70px ;
}

li.token-input-input-token-42qu {
    float: left;
    margin: 0;
    padding: 0;
    list-style-type: none;
}

div.token-input-dropdown-42qu {
    position: absolute;
    width: 400px;
    background-color: #fff;
    overflow: hidden;
    border-left: 1px solid #ccc;
    border-right: 1px solid #ccc;
    border-bottom: 1px solid #ccc;
    cursor: default;
    font-size: 11px;
    font-family: Verdana;
    z-index: 1;
}

div.token-input-dropdown-42qu p {
    margin: 0;
    padding: 5px;
    font-weight: bold;
    color: #777;
}

div.token-input-dropdown-42qu ul {
    margin: 0;
    padding: 0;
}

div.token-input-dropdown-42qu ul li {
    background-color: #fff;
    padding: 3px;
    margin: 0;
    list-style-type: none;
}

div.token-input-dropdown-42qu ul li.token-input-dropdown-item-42qu {
    background-color: #fff;
}

div.token-input-dropdown-42qu ul li.token-input-dropdown-item2-42qu {
    background-color: #fff;
}

div.token-input-dropdown-42qu ul li em {
    font-weight: bold;
    font-style: normal;
}

div.token-input-dropdown-42qu ul li.token-input-selected-dropdown-item-42qu {
    background-color: #3b5998;
    color: #fff;
}
</style>
</%def>

<%
feed = ImportFeed.where(state = IMPORT_FEED_STATE_INIT)
result={}
if feed:
    result['id'] = feed[0].id
    result['title'] = feed[0].title
    result['txt'] = feed[0].txt
    result['tags'] = feed[0].tags
    result['author_rm'] = is_rt_by_title(feed[0].title) 
    result['url']=feed[0].url

from model.rec_read import REDIS_REC_CID_TUPLE
%>

<script type="text/javascript">
$(function(){
    $("#tags").tokenInput("http:${API_URL}/po/tag",{theme: "42qu", onResult: function (results) {
var list = [],i=0,t;
for(;i<results.length;++i){
    t = results[i]
    list.push({
        id:t[0],
        name:t[1]+' '+t[2]
    })
return list 
}
/*
                    var objList = []
                    $.each(results, function() {
                        var obj = {}
                        var item = $(this)
                        obj.name = item[2]
                        obj.id = item[0]
                        obj.num = item[1]
                        objList.push(obj)
                    })
                   return objList
*/
                }
            })
});
</script>

<script type="text/x-json" id="site_data">
    ${escape(dumps(result))|n}
</script>

<script id="render_txt" type="text/x-jquery-tmpl">
    <%text>
    <form id="editform" rel="${id}">
    <input id="title" name="title" type="text" value="${title}" />
    <textarea id="txt" name="txt">{{html txt}}</textarea>

<div>
    <label for="tags">标签</label>
    <input id="tags" name="tags" type="text" value="${tags}" />
</div>

    </%text>
<div class="redis_cid c">
    % for id,name in REDIS_REC_CID_TUPLE:
    <span>
    <input type="radio" name="cid"  value="${id}" id="cid${id}"/ ><label for="cid${id}">${name}</label><br/>
    </span>
    % endfor
</div>
    <%text>

    <br/>

<div class="check">
    <input id="sync" name="sync" type="checkbox" />
    <label for="sync">同步</label>

    <input id="author_rm" name="author_rm" type="checkbox"/>
    <label for="author_rm">删除作者</label>
    <a href="${url}" target="_blank">原文链接</a>
</div>
    <input id="" name="id" style="display:none" value="${id}" type="text" />
</form>
</%text>
</script>

<div id="editwrapper">
</div>

<button id="okbtn">确认</button>
<button id="nobtn">跳过</button>

<script type="text/javascript">
    var data = $.parseJSON($("#site_data").html());
    
    function refresh_data(r)
    {
        $("#author_rm").attr('checked',data.author_rm);
        data = r||{};
    }
    function auto_height(){
        $("#txt").height($("#txt")[0].scrollHeight);
        window.scrollTo(0, 0);
    }

$("#editwrapper").html($("#render_txt").tmpl(data));

$.getJSON('/import_feed/next',refresh_data)

$("#okbtn").click(function(){
        if($("input:radio:checked").val()){
        var post_data = $("#editform").serialize();
        $("#editwrapper").html($("#render_txt").tmpl(data));
        $.postJSON('/import_feed/next',post_data ,refresh_data);
            auto_height();
        }else{
        alert("请选择类型");
        }
});

$("#nobtn").click(function(){
        var post_data = $("#editform").serialize();
        $("#editwrapper").html($("#render_txt").tmpl(data));
        $.postJSON('/import_feed/rm',post_data ,refresh_data);
        auto_height();
        });
        auto_height();

</script>
