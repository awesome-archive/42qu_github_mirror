<%!
from model.cid import CID_BUZZ_SYS, CID_BUZZ_SHOW, CID_BUZZ_FOLLOW, CID_BUZZ_WALL, CID_BUZZ_WALL_REPLY, CID_BUZZ_PO_REPLY, CID_BUZZ_ANSWER
from model.zsite import Zsite
from model.buzz import buzz_show as _buzz_show, buzz_unread_count
from cgi import escape
%>


<%def name="entry_link(entry)">
<a href="${entry.link}">${entry.name}</a>\
</%def>

<%def name="user_link_list(user_list)">
${' , '.join(['<a href="%s">%s</a>'%(i.link, escape(i.name)) for i in user_list])|n}
</%def>

<%def name="buzz_render(i)">
<%
cid = i.cid
rid = i.rid
from_list = i.from_list
entry = i.entry
%>\
%if cid == CID_BUZZ_SYS:
    <span class="buzz_sys">${entry.htm|n}</span>
%elif cid == CID_BUZZ_SHOW:
<%
career = ' , '.join(filter(bool, entry.career))
%>
<span class="buzz_user">

<a href="${entry.link}">${entry.name}\
    % if career:
 - ${career}
    % endif
 </a></span> 入驻
%elif cid == CID_BUZZ_FOLLOW:
${user_link_list(from_list)} 关注了\
    %if rid == current_user_id:
我
    %else:
 ${entry_link(entry)}
    %endif
%elif cid == CID_BUZZ_WALL:
<%
to = Zsite.mc_get(entry.to_id)
%>
${user_link_list(from_list)} 给 ${entry_link(to)} <a href="${to.link}${entry.link}">留言</a>
%elif cid == CID_BUZZ_WALL_REPLY:
<%
to = Zsite.mc_get(entry.to_id)
%>
${user_link_list(from_list)} 答复 ${entry_link(to)} 的 <a href="${to.link}${entry.link}">留言</a>
%elif cid == CID_BUZZ_PO_REPLY:
${user_link_list(from_list)} 跟帖 <a href="/po/${entry.id}">${entry.name}</a> 
%elif cid == CID_BUZZ_ANSWER:
${user_link_list(from_list)} 回答 <a href="${entry.link}#replyer${from_list[0].id}">${entry.name}</a>\
%endif
</%def>

<%def name="buzz_show(user_id)">
<%
buzz_list = _buzz_show(user_id, 3)
unread = buzz_unread_count(user_id)
%>
%if buzz_list:
<div class="c" style="padding-bottom:36px" id="buzz"><div class="G2">\
<div class="buzz">\
<div id="buzz_p">\
    %for i in buzz_list:
<p>${buzz_render(i)}</p>\
    %endfor
</div>\
<p class="tr">\
<a href="javascript:$('#buzz').slideUp();void(0)" id="buzzrm"></a>\

<a class="unread" href="/buzz">\
    %if unread:
未读<span class="mg03">${unread}</span>条\
    %else:
浏览全部\
    %endif
</a>\
</p>\
</div>\
</div></div>\
<script>\
$("#buzz_p a").attr('target','_blank')
</script>
%endif
</%def>
