<%!
from model.cid import CID_BUZZ_SYS,  CID_BUZZ_FOLLOW, CID_BUZZ_WALL, CID_BUZZ_WALL_REPLY, CID_BUZZ_PO_REPLY, CID_BUZZ_ANSWER, CID_BUZZ_EVENT_JOIN,  CID_WORD, CID_BUZZ_EVENT_FEEDBACK_JOINER, CID_BUZZ_EVENT_FEEDBACK_OWNER, CID_EVENT_NOTICE , CID_BUZZ_SITE_NEW , CID_BUZZ_SITE_FAV, CID_ZSITE_TUPLE_CN , CID_BUZZ_WORD_AT, CID_REVIEW
from model.zsite import Zsite
from model.buzz import buzz_show as _buzz_show, buzz_unread_count, buzz_show_by_cid,buzz_set_read
from zkit.txt import cnenoverflow
from model.po_event import event_feedback_id_get
from model.po import Po
from model.event import event_list_by_zsite_id
from model.cid_buzz import  CID_BUZZ_BLOCK_AROUND, CID_BUZZ_BLOCK_AT, CID_BUZZ_BLOCK_REPLY
from model.event import event_joiner_by_owner_id
%>
<%namespace file="/ctrl/_util/user.htm" import="user_link, user_career_link, user_link_list, user_link_list_with_career, po_link"/>

<%def name="buzz_render(i)">
<%
cid = i.cid
rid = i.rid
from_list = i.from_list
from_list = filter(bool, from_list)
entry = i.entry
%>\
% if cid == CID_BUZZ_SYS:
<span class="buzz_sys">${entry.htm|n}</span>
% elif cid == CID_BUZZ_FOLLOW:
    % if rid == current_user_id:
${user_link_list_with_career(from_list)} 关注了我
    % else:
${user_link_list(from_list)} 关注了 ${user_career_link(entry)}
    % endif
% elif cid == CID_BUZZ_WALL:
<%
to = Zsite.mc_get(entry.to_id)
%>
${user_link_list(from_list)} 对话 ${user_link(to)}, <a href="${to.link}${entry.link}" target="_blank">点此浏览</a>
% elif cid == CID_BUZZ_WALL_REPLY:
${user_link_list(from_list)} \
<%
e_from_id = entry.from_id
e_to_id = entry.to_id
e_from = Zsite.mc_get(e_from_id)
e_to = Zsite.mc_get(e_to_id)
%>
% if len(from_list) == 1:
<%
from_user = from_list[0]
from_id = from_user.id
%>
% if from_id == e_from_id:
答复 ${user_link(e_to)} 的 \
% elif from_id == e_to_id:
答复 ${user_link(e_from)} 的 \
% else:
回复 ${user_link(e_from)} 给 ${user_link(e_to)} 的 \
% endif
% elif set(i.from_id_list) & entry.zsite_id_list():
相互 \
% else:
回复 ${user_link(e_from)} 给 ${user_link(e_to)} 的 \
% endif
留言, <a href="${e_to.link}${entry.link}" target="_blank">点此浏览</a>
% elif cid == CID_BUZZ_PO_REPLY:
<%
po_id = entry.rid
po = Po.mc_get(po_id)
%>
${user_link_list(from_list)} 跟帖 <a target="_blank" href="/po/${po_id}">\
    % if entry.cid in (CID_WORD , CID_EVENT_NOTICE, CID_REVIEW):
${cnenoverflow(po.name,30)[0]}\
    % else:
${po.name_with_user}\
    % endif
</a> :
<span class="buzz_txt">${cnenoverflow(entry.txt, 30)[0]}<a class="zsite_reply" href="/po/${po_id}" target="_blank"></a></span>
% elif cid == CID_BUZZ_ANSWER:
${user_link_list(from_list)} 回答 <a target="_blank" href="${entry.link}\
%if from_list:
#replyer${from_list[0].id}\
%endif
">${entry.name}</a>\
%elif cid == CID_BUZZ_WORD_AT:
${user_link_list(from_list)} : <span class="buzz_txt">${entry.htm|n}</span><a target="_blank" class="zsite_reply" href="${entry.link}"></a>
% elif cid == CID_BUZZ_EVENT_JOIN:
${user_link_list(from_list)} 参加 ${po_link(entry)} 活动
% elif cid == CID_BUZZ_EVENT_FEEDBACK_OWNER:
${user_link_list(from_list)} 总结了 ${po_link(entry)} 活动 , <a href="/${rid}" target="_blank">点此浏览</a>
% elif cid == CID_BUZZ_EVENT_FEEDBACK_JOINER:
${user_link_list(from_list)} 评论了 ${po_link(entry)} 活动 , <a href="/${rid}" target="_blank">点此浏览</a>
%elif cid in (CID_BUZZ_SITE_NEW,CID_BUZZ_SITE_FAV):
${user_link_list(from_list)} 
    %if cid == CID_BUZZ_SITE_NEW:
创建
    %else:
收藏
    %endif
%if entry:
${CID_ZSITE_TUPLE_CN[entry.cid]} <a href="${entry.link}" target="_blank">${entry.name}</a>
%endif
% endif
</%def>

##########################################################

<%def name="buzz_render_event(event_list)">
    
    % for i in event_list:
    <%
    cid = i.cid
    from_list = i.from_list
    entry = i.entry
    rid = i.rid
    %>
    <div class="buzz_w">
        % if cid == CID_BUZZ_EVENT_JOIN:
        ${user_link_list(from_list)} 参加 ${po_link(entry)} 活动
        % elif cid == CID_BUZZ_EVENT_FEEDBACK_OWNER:
        ${user_link_list(from_list)} 总结了 ${po_link(entry)} 活动 , <a href="/${rid}" target="_blank">点此浏览</a>
        % elif cid == CID_BUZZ_EVENT_FEEDBACK_JOINER:
        ${user_link_list(from_list)} 评论了 ${po_link(entry)} 活动 , <a href="/${rid}" target="_blank">点此浏览</a>
        %endif
    </div>
    % endfor
</%def>

<%def name="buzz_render_reply(rlist)">
<%
from collections import defaultdict
tlist = defaultdict(list)
for i in rlist:
    tlist[i.entry.rid].append(i) 
%>
    
% for pos,(po_id,i) in enumerate(tlist.items()):
    <%
if pos > 2:
    break
po = Po.mc_get(po_id)
if not po:
    continue
    %>
    <div class="buzz_w" id="buzz${po_id}">
        <div>
            <a href="javascript:void(0)" class="buzz_x" >X</a>
            <a href="${po.link}"  target="_blank" class="buzz_li">
                % if po.cid in (CID_WORD , CID_EVENT_NOTICE, CID_REVIEW):
                ${cnenoverflow(po.name,30)[0]}\
                % else:
                ${po.name_with_user}\
                % endif
            </a>
        </div>
        <div class="buzz_au">5分钟前 , 
            <%
            repliers = set([c.from_list[0] for c in i])
            %>
            %for pos,x in enumerate(repliers):
            <a href="${x.link}" class="TPH">${x.name}</a>,
            <% 
            if pos>2:
                break
            %>
            %endfor
            等<span class="buzz_cou">${len(repliers)}</span>人回复</div>
    </div>
% endfor
</%def>

<%def name="buzz_render_at(list)">
        % for i in list:
            <div class="buzz_w">
                ${user_link_list(i.from_list)} : <span class="buzz_txt">${i.entry.htm|n}</span><a target="_blank" class="zsite_reply" href="${i.entry.link}"></a>
            </div>
        %endfor
</%def>

<%def name="buzz_render_around(li)">
    % for i in list:
    <div class="buzz_w">
        %if i.cid == CID_BUZZ_FOLLOW:
            % if i.rid == current_user_id:
            ${user_link_list_with_career(i.from_list)} 关注了我
            % else:
            ${user_link_list(i.from_list)} 关注了 ${user_career_link(i.entry)}
            % endif
        %elif i.cid in (CID_BUZZ_SITE_NEW,CID_BUZZ_SITE_FAV):
            ${user_link_list(i.from_list)} 
                %if i.cid == CID_BUZZ_SITE_NEW:
            创建
                %else:
            收藏
                %endif
            %if i.entry:
            ${CID_ZSITE_TUPLE_CN[i.entry.cid]} <a href="${i.entry.link}" target="_blank">${i.entry.name}</a>
            %endif
        %elif i.cid == CID_BUZZ_EVENT_JOIN:
            ${user_link_list(i.from_list)} 参加 ${po_link(i.entry)} 活动
        %endif
    </div>
    %endfor
    <%
    ##buzz_set_read(current_user_id,i.id)
    %>
</%def>

<%def name="buzz_render_event(user_id)">
<%
li = event_joiner_by_owner_id(user_id)
%>
%if li:
<div class="right_title">活动</div>\
<div class="buzz_win">\
%for id, name, count in li:
<div class="buzz_w">\
<a href="/event/check/${id}" target="_blank"><span class="c0">${name}</span> <span class="c9">:</span> <span class="mr3">+${count}</span>报名 , 请确认</a>\
</div>\
%endfor
</div>\
%endif
</%def>

<%def name="buzz_show(user_id)">
${buzz_render_event(user_id)}
<%
limit = 300
at_list = buzz_show_by_cid(user_id,limit,CID_BUZZ_WORD_AT)


follow_list = buzz_show_by_cid(user_id,limit,CID_BUZZ_FOLLOW)
follow_list.extend(buzz_show_by_cid(user_id,limit,CID_BUZZ_SITE_NEW))
follow_list.extend(buzz_show_by_cid(user_id,limit,CID_BUZZ_SITE_FAV))
follow_list.extend(buzz_show_by_cid(user_id,limit,CID_BUZZ_EVENT_JOIN))
follow_list.extend(buzz_show_by_cid(user_id,limit,CID_BUZZ_EVENT_FEEDBACK_JOINER))
follow_list.extend(buzz_show_by_cid(user_id,limit,CID_BUZZ_EVENT_FEEDBACK_OWNER))

reply_list = buzz_show_by_cid(user_id,10,CID_BUZZ_PO_REPLY)
reply_list.extend(buzz_show_by_cid(user_id,10,CID_BUZZ_ANSWER))

%>
%for render, li, cid , name in (\
    (buzz_render_at       ,    at_list  , CID_BUZZ_BLOCK_AT       ,   "提到我" ),\
    (buzz_render_around   , follow_list , CID_BUZZ_BLOCK_AROUND   ,   "新鲜事" ),\
    (buzz_render_reply    , reply_list  , CID_BUZZ_BLOCK_REPLY    ,   "讨论区" ),\
):
    %if li:
<div class="right_title">${name}\
<a href="javascript:void(0)" class="buzz_block_x" rel="${cid}">X</a></div>\
<div class="buzz_win">\
${render(li)}\
</div>\
    %endif
%endfor
</%def>
