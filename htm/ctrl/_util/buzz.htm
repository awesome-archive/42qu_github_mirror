<%!
from model.cid import CID_BUZZ_SYS, CID_BUZZ_SHOW, CID_BUZZ_FOLLOW, CID_BUZZ_WALL, CID_BUZZ_WALL_REPLY, CID_BUZZ_PO_REPLY
from model.zsite import Zsite
from model.buzz import buzz_show as _buzz_show, buzz_unread_count
%>


<%def name="entry_link(entry)">
<a href="${entry.link}">${entry.name}</a>\
</%def>

<%def name="user_link_list(user_list)">
${','.join([entry_link(i) for i in user_list])}
</%def>

<%def name="buzz_render(i)">
<%
cid = i.cid
rid = i.rid
from_list = i.from_list
entry = i.entry
%>\
%if cid == CID_BUZZ_SYS:
    <span class="buzz_sys">${entry.htm|n}</span>
%elif cid == CID_BUZZ_SHOW:
    <span class="buzz_user">${entry_link(entry)}</span>
%elif cid == CID_BUZZ_FOLLOW:
${user_link_list(from_list)} 关注了\
    %if rid == current_user_id:
我
    %else:
 ${entry_link(entry)}
    %endif
%elif cid == CID_BUZZ_WALL:
<%
to = Zsite.mc_get(entry.to_id)
%>
${user_link_list(from_list)} 给 ${entry_link(to)} <a href="${to.link}${entry.link}">留言</a>
%elif cid == CID_BUZZ_WALL_REPLY:
<%
to = Zsite.mc_get(entry.to_id)
%>
${user_link_list(from_list)} 回复 ${entry_link(to)} 的 <a href="${to.link}${entry.link}">留言</a>
%elif cid == CID_BUZZ_PO_REPLY:
${user_link_list(from_list)} 回复  <a href="/po/${entry.id}">${entry.name}</a> 
%endif
</%def>

<%def name="buzz_show(user_id)">
<%
buzz_list = _buzz_show(user_id, 3)
unread = buzz_unread_count(user_id)
%>
<div class="buzz">
%for i in buzz_list:
<p>${buzz_render(i)}</p>
%endfor
<p class="tr"><a href="/buzz">未读<span class="mg03">${unread}</span>条</a></p>
</div>
</%def>
