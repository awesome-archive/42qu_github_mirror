<%!
from yajl import dumps
%>
<%inherit file="_base.htm" />
<%namespace file="/ctrl/_util/htm.htm" name="htm"/>
<%def name="head()">
<script src="${js.date}"></script>
${css.ctrl_history|n}
<style>
    .begin select, .end select {
    border: 1px solid #CCCCCC;
    margin-right: 8px;
    padding: 8px;
    }
</style>
</%def>

<%htm:form id="history_form">
<p class="tl career">职业生涯</p>
<div class="history c" id="history_job"></div>
<p class="tl career career_edu">教育背景</p>
<div class="history c" id="history_edu"></div>
<div class="btns">
    <span class="btnw"><button class="btn">保存</button></span>
</div>
</%htm:form>


<%text>
<script id="history_tmpl" type="text/x-jquery-tmpl">
<div class="line">
<span class="L">
    <input type="hidden" name="${name}_id" value="${id}">
    <input placeholder="${unit_placeholder}" name="${name}_unit" class="unit" autocomplete="off">
    <input placeholder="${title_placeholder}" name="${name}_title" class="title" autocomplete="off">
    <input placeholder="经历简述 ... ..." name="${name}_txt" class="txt">
    <span class="begin"></span> - <span class="end"></span>
    <input name="${name}_now" type="checkbox" class="now"><label class="label_now">当前</label>
</span>
<a href="javascript:void(0)" title="删除" class="rm"></a>
</div>
</script>
</%text>

<script>

function select_workday(prefix, elem, val){
    val = val||0;
    var date=new Date(), year=date.getFullYear();
    select_span(elem, prefix+"_"+elem[0].className, val, year, year-99)
}

function history(id , result){
    result.name = id
    var div = $("#history_"+id),
        history = $('#history_tmpl').tmpl(result).appendTo(div),
        end = history.find("span.end"),
        begin = history.find("span.begin"),
        uid = uuid(),
        now = history.find('input.now').attr("id",uid),
        label = history.find(".label_now").attr("for",uid);
        history.find('[placeholder]').placeholder();

        now.change(function(){
            if(this.checked){
                end.fadeOut()
            }else{
                end.fadeIn()
            }
            end.find("input[type=hidden]").val("-1")
        }).attr('checked',false)

        history.find('.rm').click(function(){
            history.fadeOut(function(){
                history.remove()
            })
        });

        div.find(".rm").show();
        div.find(".rm:last").hide(); 
        select_workday(id, begin)
        select_workday(id, end)
}
function history_job(unit, title){
    var result = {
        "unit_placeholder"  : "单位",
        "title_placeholder" : "头衔"        
    }
    history("job" , result)
}
function history_edu(unit, title){
    var result = {
        "unit_placeholder"  : "学校",
        "title_placeholder" : "专业"        
    }
    history("edu" , result)
}
$(".history").delegate('.unit:last,.title:last', "change", function(){
    var val = $.trim(this.value);
    if(val.length&&val!=this.placeholder){
        window['history_'+(this.name.split("_")[0])]()
    }
})
$("#history_form").submit(function(){
    $("input[placeholder]").each(function(){
        if(this.value==this.placeholder){
            this.value=''
        }
    })
})
history_edu()
history_job()
</script>



