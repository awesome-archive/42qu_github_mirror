<%!
from model.reply import STATE_SECRET, STATE_ACTIVE
from zkit.time_format import friendly_time
from model.zsite import Zsite
from model.wall import Wall
%>
<%namespace file="/ctrl/main/_util/htm.htm" name="htm"/>
<%def name="reply_render_body(i, can_see=False)">
<%
secret = i.state==STATE_SECRET
if can_see is False:
    if secret:
        if i.user_id == current_user_id:
            can_see = True
        elif zsite_id == current_user_id:
            can_see = True
    else:
        can_see = True
%>
%if secret:
悄悄说
%else:
说
%endif
:
%if can_see:
<pre>${i.htm|n}</pre>
%else:
<span style="color:#999">省略 ${len(i.txt.decode('utf-8','ignore'))} 字 ...</span>
%endif
</%def>



<%def name="reply_render(i)">
<%
user = i.user
user_id = user.id
if zsite_id == user_id:
    wall = Wall.mc_get(i.rid)
    from_id = wall.from_id
    to_id = wall.to_id
    if zsite_id == from_id:
        other_id = to_id
    else:
        other_id = from_id
    if other_id == zsite_id:
        other_id = None
else:
    other_id = None
%>\
<div>\
%if other_id:
<%
other = Zsite.mc_get(other_id)
%>
对 <a href="${other.link}">${other.name}</a>\
%else:
<a href="${user.link}">${user.name}</a>\
%endif
${reply_render_body(i)}\
<div>\
${friendly_time(i.create_time)}\
<a target="_blank" href="/wall/reply2txt/${i.id}">回复</a>\
</div>\
</div>\
</%def>




<%def name="reply_textarea(action)">
<%htm:form id="reply_form" action="${action}">\
<textarea id="reply_txt" name="txt"></textarea>\
<input type="checkbox" name="secret" id="secret">\
<label for="secret">悄悄话</label>\
<button type="submit">此致 , 敬礼</button>\
</%htm:form>\
<script>$("#reply_form").elastic_login()</script>\
</%def>
