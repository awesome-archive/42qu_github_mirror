<%inherit file="_po.htm" />
<%namespace file="/ctrl/_util/htm.htm" name="htm"/>
<%namespace file="_vote.htm" import="po_bar_vote"/>
<%namespace file="/ctrl/zsite/event/event_feedback_list.htm" import="feedback_list"/>
<%!
from model.fs import fs_url_jpg
from model.ico import pic_url_bind_with_default
from model.career import career_bind
from model.days import begin_end_by_minute 
from zkit.earth import place_name
from model.event import Event, event_joiner_check_count, event_joiner_user_list, event_joiner_user_id_list, EVENT_STATE_DEL, EVENT_STATE_INIT, EVENT_STATE_REJECT, EVENT_STATE_TO_REVIEW, EVENT_STATE_BEGIN, EVENT_STATE_NOW, EVENT_STATE_END,  event_joiner_state
from model.po_event import event_feedback_id_get
%>
<%def name="po_body()">
<%
id = po.id
event = Event.mc_get(id)
state = event.state
can_admin = event.can_admin(current_user_id)
%>

% if can_admin or state >= EVENT_STATE_BEGIN:
<%
pic_url = fs_url_jpg(162, event.pic_id)

row1, row2, diff_day = begin_end_by_minute(
    event.begin_time,
    event.end_time
)

join_check_count = event_joiner_check_count(id)
join_count = event.join_count
join_list = event_joiner_user_list(id)
career_bind(join_list)
pic_url_bind_with_default(join_list, '219')
price = event.price
reply_count = po.reply_count

event_state = event.state
join_state = event_joiner_state(id, current_user_id)
%>
%if join_state and event_state >= EVENT_STATE_END:
    %if event_feedback_id_get(current_user_id, id):
<div class="feedback_top"><a href="/event/feedback/${id}">\
点击这里 , \
%if current_user_id == po.user_id:
总结\
%else:
评价\
%endif
活动\
</a></div>\
    %endif
%endif
 
<div class="c" id="event_page">
% if pic_url:
    <img src="${pic_url}" id="event_img">
% endif
    <div id="event_txt">
    <div id="po_name">${po.name}</div>


<p>地点<span class="colon">:</span>${place_name(event.pid)}</p>
<p class="ml48">${event.address}</p>

<p class="mt14">时间<span class="colon">:</span>${row1}</p>
%if diff_day:
<p class="ml14">至<span class="ml20">${row2}</span></p>
%else:
<p class="ml48">${row2}</p>
%endif

</div>
</div>

<div class="w721">
<pre class="prebody">\
${po.htm|n}\
<p>联系电话 : ${event.phone}</p>\
<p>交通方式 : ${event.transport}</p>\
<form id="event_join_btn" action="/event/${'check' if can_admin else 'join'}/${id}" ><span class="btnw"><button type="submit">报名${'管理' if can_admin else '参加'}</button></span>\
% if can_admin and join_check_count:
<span id="to_confirm">\
<a href="/event/check/${id}"><span class="mr3">${join_check_count}</span>待确认</a>\
</span>
% endif
% if price:
<span id="price_per">${price} 元 / 人</span>\
% endif
</form>\
<p class="po_bar po_bar1">
% if can_admin:
<a class="L" href="/po/event/${id}">编辑</a>\
% endif
组织者 : <a href="${zsite.link}">${zsite.name}</a></p>\
${po_bar_vote(po)}\
</pre>
%if state>= EVENT_STATE_END:
${feedback_list(id)}
%endif
<div class="spline">
<span>${join_count}</span> 报名
</div>
<div class="G">

<div class="G3">

<div id="joiner" class="G">
% for i in join_list:
<%
unit, title = i.career
%>
<a href="${i.link}" class="c0">
<div class="G1">
    <img src="${i.pic219}">
    <div>${i.name}</div>
% if unit:
    <div class="tr">${unit}</div>
% endif
% if title:
    <div class="tr">${title}</div>
% endif
</div>
</a>
% endfor
</div>
</div>
</div>



<div class="spline">
% if reply_count:
<span>${reply_count}</span>
% endif
留言
</div>



</div></div></div>



% else:
活动尚未通过审批
% endif

</div>
<script src="${js.ctrl_zsite|n}"></script>
</%def>
