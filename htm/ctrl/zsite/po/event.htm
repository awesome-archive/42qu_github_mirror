<%inherit file="_po.htm" />
<%namespace file="/ctrl/_util/htm.htm" name="htm"/>
<%namespace file="_vote.htm" import="po_bar_vote"/>
<%namespace file="/_util/event.htm" import="event_show"/>
<%namespace file="/ctrl/zsite/event/event_feedback_list.htm" import="feedback_list"/>
<%!
from model.ico import pic_url_bind_with_default
from model.career import career_bind
from model.event import Event, event_joiner_check_count, event_joiner_user_list, event_joiner_user_id_list, EVENT_STATE_DEL, EVENT_STATE_INIT, EVENT_STATE_REJECT, EVENT_STATE_TO_REVIEW, EVENT_STATE_BEGIN, EVENT_STATE_NOW, EVENT_STATE_END,  event_joiner_state
from model.po_event import event_feedback_id_get

%>
<%def name="po_body()">
<%
id = po.id
event = Event.mc_get(id)
state = event.state
can_admin = event.can_admin(current_user_id)
%>


% if can_admin or state >= EVENT_STATE_BEGIN:
<%

join_check_count = event_joiner_check_count(id)
join_count = event.join_count
join_list = event_joiner_user_list(id)
career_bind(join_list)
pic_url_bind_with_default(join_list, '219')
price = event.price
reply_count = po.reply_count

event_state = event.state
join_state = event_joiner_state(id, current_user_id)

%>
%if event_state == EVENT_STATE_REJECT:
<div class="feedback_top">活动未通过审核</div>\
%elif event_state == EVENT_STATE_TO_REVIEW:
<div class="feedback_top">活动审核中 , 请耐心等待</div>\
%elif join_state and event_state >= EVENT_STATE_END:
    %if not event_feedback_id_get(current_user_id, id):
<a href="/event/feedback/${id}"><div class="feedback_top">\
点击这里 , \
%if current_user_id == po.user_id:
总结\
%else:
评价\
%endif
活动\
</div></a>\
    %endif
% elif can_admin and join_check_count:
<a href="/event/check/${id}"><div class="feedback_top"><span class="mr3">${join_check_count}</span>人新报名 , 请审批确认</div></a>\
% endif

<div class="c event_page">
${event_show(event, po)}
</div>\

<div class="w721">
<pre class="prebody">\
${po.htm|n}\
<p>联系电话 : ${event.phone}</p>\
<p>交通方式 : ${event.transport}</p>\
%if not can_admin:
<form id="event_join_btn" action="/event/${'check' if can_admin else 'join'}/${id}" ><span class="btnw"><button type="submit">报名参加</button></span>\
% if price:
<span id="price_per">${price} 元 / 人</span>\
% endif
%elif price:
<p>\
活动费用 : ${price} 元 / 人\
</p>\
%endif
</form>\
<p class="po_bar">\
% if can_admin:
<a class="L" href="/po/event/${id}">管理</a>\
% endif
组织者 : <a href="${zsite.link}">${zsite.name}</a></p>\
${po_bar_vote(po)}\
</pre>
%if state>= EVENT_STATE_END:
${feedback_list(event)}
%endif
<div class="spline">
<span>${join_count}</span> 报名
</div>
<div class="G">

<div class="G3">

<div id="joiner" class="G">
% for i in join_list:
<%
unit, title = i.career
%>
<a href="${i.link}" class="c0">
<div class="G1">
    <img src="${i.pic219}">
    <div>${i.name}</div>
% if unit:
    <div class="tr">${unit}</div>
% endif
% if title:
    <div class="tr">${title}</div>
% endif
</div>
</a>
% endfor
</div>
</div>
</div>



<div class="spline">
% if reply_count:
<span>${reply_count}</span>
% endif
留言
</div>



</div></div></div>



% else:
活动尚未通过审批
% endif

</div>
<script src="${js.ctrl_zsite|n}"></script>
</%def>
