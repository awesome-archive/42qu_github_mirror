<%inherit file="/ctrl/_base/zsite.htm" />
<%namespace file="/ctrl/_util/htm.htm" name="htm"/>

<%!
from model.state import STATE_SECRET, STATE_DEL
from model.zsite_url import url_or_id
from model.cid import CID_QUESTION, CID_PHOTO
from model.event import CID_EVENT_FEEDBACK, can_feedback
from datetime import datetime
%>

<%def name="htm_title()">
%if can_view:
${po.name} - ${zsite.name}\
%if tag_name:
 - ${tag_name}
%endif 
%endif
</%def>
<%def name="htm_head()">
${css.ctrl_po|n}
<link rel="alternate" href="/rss" type="application/rss+xml" title="${zsite.name} - 文章" />
</%def>
<%
if zsite_tag_id:
    tag_link = "tag/%s" % zsite_tag_id
else:
    tag_link = "po/cid/%s"%po.cid
%>

<%
cid = po.cid
po_state = po.state
%>
<a title="上一层" href="/${tag_link}" id="sT"></a>

<div class="po_page">
<div class="po_body" id="po_body">
    %if prev_id:
<a href="/${prev_id}#po_body" class="sprev"></a>
    %endif
    %if next_id:
<a href="/${next_id}#po_body" class="snext"></a>
    %endif

    %if can_view:
${next.po_body()}\
##close po_body
</div>\
${self.reply_list()}\
    %else:
<style>
.fullscreen p{
line-height:64px
}
.fullscreen{
font-size:16px;text-align:center;margin-top:10%;
}
</style>
<div class="fullscreen">
<p>
    %if po_state == STATE_DEL:
啊 , 被删除了 !!!
    %elif po_state == STATE_SECRET:
私密文件 , 无权浏览
    %else:
不可见的状态 ${po_state}
    %endif
</p>
<p>
<a href="/">点此回首页</a>
</p>
</div>
##close po_body
</div>
    %endif
</div>

<script src="${js.ctrl_po_po}"></script>\
<script src="${js.ctrl_feed}")></script>

<%def name="reply_list()">
<%
po_id = str(po.id)
%>
<div id="reply_list">
    %for reply in po.reply_list():
<%
user = reply.user
user_id = user.id
%>
<div class="sdw" id="reply${reply.id}"><div class="sd">
    <pre>${reply.htm|n}</pre>
    <div class="bar">
%if can_admin or reply.can_rm(current_user_id):
    <a href="javascript:rm(${reply.id});void(0)" class="rm">删除</a> 
%endif
<a href="${user.link}" class="replyer">${user.name}</a> 
<a class="reply_at" rel="${url_or_id(user_id)}" href="javascript:void(0)"></a>
    </div>
</div></div>
    %endfor
</div>
    %if po.state > STATE_SECRET:
        %if po.cid == CID_EVENT_FEEDBACK:
            <%
            event_id = str(po.rid)
            user_can_feedback = can_feedback(po, current_user_id)
            %>
            %if user_can_feedback:
                <%htm:form id="txt_form" action="/event/feedback/reply/${event_id}">\
                ${htm.reply_textarea()}
                <div class="btns">\
                    <input type="checkbox" name="satisfaction" id="satisfaction">
                    <label for="satisfaction" id="secret_label">满意</label>
                    <span class="btnw"><button type="submit">反馈</button></span>\
                </div>
                </%htm:form>
            %endif
        %else:
            <%htm:form id="txt_form" action="/po/reply/${po_id}">\
            ${htm.reply_textarea()}
            <div class="btns">\
            %if cid == CID_QUESTION:
            <a class="reply_a" href="${po.link}">回答</a>\
            <span class="btnw"><button  type="submit">评注</button></span>\
            %else:
            <span class="btnw"><button  type="submit">此致 , 敬礼</button></span>\
            %endif
            </div>
            </%htm:form>
        %endif
    %endif
</%def>
