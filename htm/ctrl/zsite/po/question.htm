<%!
from datetime import datetime
from model.vote import vote_state, vote_count
from model.po_question import answer_id_get, po_answer_list
from model.state import STATE_SECRET, STATE_DEL
from model.cid import CID_NOTE
%>
<%inherit file="/ctrl/_base/zsite.htm" />
<%namespace file="/ctrl/_util/htm.htm" name="htm"/>

<%def name="htm_title()">
%if can_view:
${po.name}
%endif
</%def>
<%def name="htm_head()">
${css.ctrl_po|n}
</%def>

<%
po_id = str(po.id)
po_state = po.state
%>

%if can_view:
<h1>${po.name}</h1>
<pre>${po.htm|n}</pre>
<div>${datetime.fromtimestamp(po.create_time)}</div>
<div>
    %if can_admin:
        <a href="/question/edit/${po_id}">编辑</a>
    %endif
    <a href="/question/reply">${po.reply_count}评注</a> 
</div>

<span class="vote${vote_state(current_user_id, po_id)}" id="vote${po_id}">
<a class="down" href="javascript:vote_down(${po_id});void(0)">-</a>
<span class="num">${vote_count(po_id)}</span>
<a class="up" href="javascript:vote_up(${po_id});void(0)">+</a>
</span>

%for answer in po_answer_list(po_id):
<%
answer_id = answer.id
user = answer.user
%>
<div id="answer${answer_id}">
<h1>${answer.name}</h1>
%if answer.cid == CID_NOTE:
<pre>${answer.htm|n}</pre>
%endif

%if answer.can_view(current_user_id):
<a href="${answer.link}">${user.name}</a>
%if answer.can_admin(current_user_id):
<a href="${answer.link_edit}">编辑</a>
%endif
%else:
匿名回答
%endif
</div>
%endfor

    %if po_state > STATE_SECRET and not answer_id_get(current_user_id, po_id):
<%htm:form id="answer" action="/question/${po_id}">
<input type="text" name="name" id="name">
<hr>
<textarea id="txt" name="txt"></textarea>
<div>
<button type="submit">此致 , 敬礼</button>
</div>
</%htm:form>
    %endif
%else:
<div>
    %if po_state == STATE_DEL:
啊 , 被删除了 !!!
    %elif po_state == STATE_SECRET:
机密文件 , 无关人士 , 禁止入内
    %else:
不可见的状态 ${po_state}
    %endif
</div>
%endif

<script src="${js.ctrl_po_po}"></script>
<script src="${js.ctrl_feed}"></script>
